name: process livestock GPS data v-1.0

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  process-data:
    runs-on: ubuntu-latest

    container:
      image: ghcr.io/asalonio/gps-processing:1.0

    steps:
    - name: Checkout repository
      uses: actions/checkout@v3
      with:
        fetch-depth: 0

    - name: Download data
      run: |
        curl -L https://storage.googleapis.com/gps_data_processing/data-v1.zip -o data.zip
        unzip data.zip

    - name: Debug data structure
      run: |
        pwd
        find data -maxdepth 3 -type f | head -50

    - name: Run clean_I - Spatial Data Cleaning
      run: Rscript clean_I.R
      env:
        RAW_DATA_PATH: ${{ github.workspace }}/${{ github.workspace }}/data
        PROCESSED_DATA_PATH: ${{ github.workspace }}/${{ github.workspace }}/data/processed
        OUTPUT_PATH: ${{ github.workspace }}/${{ github.workspace }}/output

    - name: Run clean_II - Grazing Demand Analysis
      run: Rscript clean_II.R
      env:
        PROCESSED_DATA_PATH: ${{ github.workspace }}/data/processed
        OUTPUT_PATH: ${{ github.workspace }}/output

    - name: Run clean_III - Landscape Analysis
      run: Rscript clean_III.R
      env:
        RAW_DATA_PATH: ${{ github.workspace }}/data
        PROCESSED_DATA_PATH: ${{ github.workspace }}/data/processed
        OUTPUT_PATH: ${{ github.workspace }}/output

    - name: Run EDA
      run: Rscript eda.R
      env:
        PROCESSED_DATA_PATH: ${{ github.workspace }}/data/processed
        OUTPUT_PATH: ${{ github.workspace }}/output

    - name: Upload outputs
      uses: actions/upload-artifact@v4
      with:
        name: results
        path: |
          output/*.csv
          output/*.png
          data/processed/*.csv
